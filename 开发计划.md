# 刘海屏效率应用 开发计划

> 本文档为本项目的独立“开发计划与进度追踪”文档，配合《开发规范.md》《AI知识库.md》一起使用。通过 Markdown 复选框（`[ ]`/`[x]`）标记每个阶段与子任务的完成情况。

## 1. 使用约定

- **计划文档的作用**：
  - 记录当前版本（v1/v2/v3）的整体开发路径。
  - 跟踪各阶段是否完成，便于回顾和后续迭代规划。
- **进度标记方式**：
  - 未完成：`[ ]`（例如：`- [ ] 阶段 1：需求与规范整理`）。
  - 已完成：`[x]`（例如：`- [x] 阶段 1：需求与规范整理`）。
- **更新原则**：
  - 当某个阶段或子任务完成后，由人类开发者或 AI 将对应项从 `[ ]` 改为 `[x]`。
  - 若有新任务出现或功能范围调整，应在本文件中增加/修改对应条目，并同步更新《AI知识库.md》中的设计决策。

## 2. 总体开发阶段

> 当前按照 v1 → v2 → v3 的顺序推进，每一阶段可以再拆分为更细任务。

### 2.1 阶段 1：需求与规范整理

- [x] **阶段 1：需求与规范整理**
  - [x] 明确项目目标和整体定位（刘海信息中心、对标 NookX）。
  - [x] 确定功能版本规划：v1（核心版）、v2（增强版）、v3（AI 进阶版）。
  - [x] 完成《开发规范.md》初稿并确认。
  - [x] 完成《AI知识库.md》初稿并确认。

> 说明：当以上子项全部完成后，可将“阶段 1”这一行改为 `[x]`。

### 2.2 阶段 2：工程骨架与基础结构

- [x] **阶段 2：工程骨架与基础结构**
  - [x] 在本仓库中创建 SwiftUI macOS App 工程（原生 App）。
  - [x] 建立基础目录结构：
    - [x] `App/`：应用入口、AppDelegate 等。
    - [x] `Modules/`：NotchBar、StatusBar、Time、Weather、Todo 等模块。
    - [x] `Services/`：网络服务、配置管理、持久化等。
    - [x] `Shared/`：通用组件、工具函数、扩展。
  - [x] 确保工程可以在有刘海的 Mac 上运行，显示一个最简单的窗口或视图。

### 2.3 阶段 3：v1 基础能力

- [x] **阶段 3：v1 基础能力**
  - [x] 实现刘海信息条 NotchBar：
    - [x] 窗口定位在刘海区域附近，不遮挡系统元素。
    - [x] 显示基础文本（例如当前时间占位）。
  - [x] 实现菜单栏 StatusBar：
    - [x] 菜单栏图标显示。
    - [x] 基础菜单项（打开设置、退出应用）。
  - [x] 实现设置入口：
    - [x] 打开偏好设置窗口。
    - [x] 至少包含主题模式、开机自启等基础开关的预留位置。

### 2.4 阶段 4：v1 核心功能模块

- [x] **阶段 4：v1 核心功能模块**
  - [x] 时间/日期模块：
    - [x] 实时显示当前时间、日期、星期。
    - [x] 与刘海信息条集成，定时刷新。
  - [x] 天气模块：
    - [ ] 设计天气数据结构和服务接口（当前为 Mock，预留接口）。
    - [x] 接入真实天气 API 或使用 Mock 数据。
    - [x] 在刘海信息条显示天气图标与温度。
  - [x] Todo 模块：
    - [x] 实现添加、勾选、删除待办。
    - [x] 使用本地持久化（如 UserDefaults）。
    - [x] 在展开面板中展示待办列表。
  - [x] **刘海动态交互与动画实现（重要调整）**：
    - [x] 重构 NotchBarWindowController 支持动态尺寸变化。
    - [x] 增加全局鼠标监听（NSEvent.addGlobalMonitorForEvents）监听顶部区域。
    - [x] 获取并适配物理刘海的真实位置（使用 screen.frame 而非 visibleFrame）。
    - [x] NotchBarView 支持收起/展开两种状态的 UI 切换。
    - [x] **动画实现与圆角问题解决**：
      - [x] 展开动画：200×38 → 600×120，动画时长 0.3 秒。
      - [x] 底部圆角始终保持 16pt，顶部直角。
      - [x] 内容在动画完成后才淡入显示（避免文字显示在桌面上）。
      - [x] 使用 CAShapeLayer + CABasicAnimation 解决 SwiftUI Shape 插值失真问题。

#### 4.1 刘海动画开发总结（重要经验）

> **背景**：刘海条展开/收起动画是核心交互，要求底部圆角在动画过程中始终保持 16pt，不能有从尖角到圆角的变化。

**遇到的问题**：
1. **SwiftUI UnevenRoundedRectangle 插值失真**：
   - 当 frame 尺寸动画时（200×38 → 600×120），SwiftUI 会对 Shape 的 path 进行插值。
   - 导致底部圆角在动画过程中变形，先变成尖角再变回圆角。
   - 尝试固定 cornerRadius、使用 animatableData、mask 裁剪等方案均失败。

2. **NSView layer 圆角设置无效**：
   - 在 NSHostingView 上设置 layer.cornerRadius 无效。
   - SwiftUI 会重置 layer 属性。

3. **clipShape 方案失败**：
   - 用 .clipShape(UnevenRoundedRectangle) 仍然有插值问题。
   - SwiftUI 的动画系统会对所有可动画属性进行插值。

**最终解决方案**：
- **使用 AppKit 的 CAShapeLayer + CABasicAnimation**：
  - 创建自定义 NSView（NotchBarContainerView）。
  - 用 CAShapeLayer 绘制带圆角的形状。
  - 用 CABasicAnimation 对 path 进行动画，圆角半径始终固定 16pt。
  - SwiftUI 内容通过 NSHostingView 嵌入在自定义 View 中。

**技术要点**：
```swift
// 1. NotchBarContainerView 管理 CAShapeLayer
class NotchBarContainerView: NSView {
    private let shapeLayer = CAShapeLayer()
    
    func updateExpanded(_ expanded: Bool) {
        let animation = CABasicAnimation(keyPath: "path")
        animation.duration = 0.3
        // path 动画，圆角位置固定
    }
}

// 2. ViewModel 通过回调通知动画
class NotchBarViewModel: ObservableObject {
    var onExpandedChanged: ((Bool) -> Void)?
}

// 3. 内容延迟显示
.onChange(of: viewModel.isExpanded) { _, newValue in
    if newValue {
        showContent = false
        DispatchQueue.main.asyncAfter(deadline: .now() + 0.3) {
            showContent = true
        }
    }
}
```

**关键文件**：
- `/Users/ryan/Learn/BarHold/NotchIsland/NotchIsland/App/NotchIslandApp.swift`
  - NotchBarWindowController：窗口管理、鼠标监听
  - NotchBarContainerView：CAShapeLayer 动画实现
  - NotchBarViewModel：状态管理和回调
  - NotchBarView：SwiftUI 内容视图

**经验教训**：
1. SwiftUI 的 Shape 动画在复杂场景下难以精确控制，特别是需要保持部分属性不变时。
2. 混合使用 AppKit 和 SwiftUI 可以发挥各自优势：AppKit 做精确动画，SwiftUI 做内容布局。
3. CAShapeLayer 的 path 动画可以完全控制形状变化，避免插值失真。
4. 动画时长和内容显示时机要精确同步，避免视觉瑕疵。

**开发耗时**：约 2-3 小时，尝试了多种方案才找到最佳解决方案。

### 2.5 阶段 5：v2 结构预埋

- [x] **阶段 5：v2 结构预埋**
  - [x] 快捷方式模块（Shortcuts / Launcher）：
    - [x] 定义快捷方式数据模型（类型、名称、图标、目标地址等）。
    - [x] 设计模块接口（添加/删除/更新/列出）。
  - [x] 番茄钟模块（Pomodoro）：
    - [x] 定义状态（未开始/专注中/休息中）以及配置项（时长）。
    - [x] 设计计时与状态切换逻辑接口。
  - [x] 音乐模块（Music）：
    - [x] 定义音乐信息模型（歌名、歌手、进度等）。
    - [x] 预留与系统音乐服务（如 Apple Music）的集成接口。

#### 5.1 v2 结构预埋总结

> **完成时间**：2026-01-12

**已创建的模块结构**：

1. **快捷方式模块（Shortcuts）**：
   - `ShortcutItem.swift`：数据模型，支持应用、网址、文件夹三种类型。
   - `ShortcutService.swift`：单例服务，提供 CRUD、持久化、图标获取接口。
   - 特性：支持排序、拖拽重排、网站图标缓存（预留实现）。

2. **番茄钟模块（Pomodoro）**：
   - `PomodoroState.swift`：状态和配置模型（专注/短休息/长休息）。
   - `PomodoroService.swift`：单例服务，提供计时、状态切换、系统通知。
   - 特性：支持自动切换、长休息间隔、进度追踪。

3. **音乐模块（Music）**：
   - `MusicInfo.swift`：音乐信息模型（歌曲名、艺术家、封面、进度）。
   - `MusicService.swift`：单例服务，提供音乐信息监听、播放控制。
   - 特性：支持 Apple Music / Spotify（预留 ScriptingBridge 实现）。

**技术设计**：
- 所有服务采用单例模式（`shared`）+ ObservableObject。
- 数据持久化使用 UserDefaults（快捷方式、番茄钟配置）。
- 预留接口清晰，便于阶段 6 快速实现 UI 和具体功能。

**关键文件**：
- `/Users/ryan/Learn/BarHold/NotchIsland/NotchIsland/Modules/Shortcuts/`
- `/Users/ryan/Learn/BarHold/NotchIsland/NotchIsland/Modules/Pomodoro/`
- `/Users/ryan/Learn/BarHold/NotchIsland/NotchIsland/Modules/Music/`

### 2.6 阶段 6：v2 功能完善

- [x] **阶段 6：v2 功能完善**
  - [x] 快捷方式模块：
    - [x] 实现默认快捷方式（Safari、访达、终端、下载、应用程序）。
    - [x] 在展开区域显示快捷方式网格，支持点击打开。
    - [x] 网站图标使用 Safari 图标，避免黑色背景下不可见。
    - [x] 快捷方式添加/编辑功能（弹窗表单）。
    - [x] 网址自动获取图标（favicon）（Google API + 回退机制）。
    - [x] 网址智能识别（自动补全 https://）。
    - [x] 网站标题自动提取（HTML title 标签）。
  - [x] 番茄钟模块：
    - [x] 完整实现计时逻辑和状态切换（专注/短休息/长休息）。
    - [x] 实现开始/暂停/继续/跳过/停止控制按钮。
    - [x] 实现进度条和剩余时间显示。
    - [x] 实现已完成番茄钟数量统计。
    - [x] 修复暂停状态下继续按钮显示问题。
    - [x] 操作按钮尺寸优化（52pt）。
    - [x] 集成系统通知（完成/休息提醒）。
  - [x] 音乐模块：
    - [x] 读取当前播放音乐信息（Apple Music / Spotify）。
    - [x] 显示歌名、艺术家、专辑、进度。
    - [x] 播放控制（播放/暂停、上一曲、下一曲）。
    - [x] 后台线程轮询（1秒刷新）。
    - [x] 按需监听优化（只在音乐模块激活时轮询）。
    - [x] 左右布局优化（封面 100×100 + 控制按钮）。
  - [x] 交互与动画优化：
    - [x] 实现刘海动态展开/收起交互：
      - [x] 监听鼠标移入物理刘海区域（200×55），触发展开动画。
      - [x] 展开区域从 200×38 动画到 700×250（0.3 秒）。
      - [x] 内容在动画完成后淡入显示（0.15 秒延迟 + 0.15 秒淡入）。
      - [x] 鼠标在展开区域内移动不会触发收起。
      - [x] 鼠标完全离开展开区域才收起。
    - [x] 模块切换器（快捷方式/番茄钟）实现。
    - [x] 容器尺寸优化（700×250）满足内容显示需求。

#### 6.1 v2 功能完善总结

> **完成时间**：2026-01-13

**已实现的功能**：

1. **快捷方式模块**：
   - 默认 5 个快捷方式：Safari、Finder、Terminal、Downloads、Applications。
   - 横向滚动网格布局（LazyHGrid）。
   - 点击快捷方式打开应用/网站/文件夹。
   - 图标显示优化：网站使用 Safari 图标（避免黑色 globe 不可见）。
   - 右上角 + 按钮预留（功能待实现）。

2. **番茄钟模块**：
   - 完整计时逻辑：25 分钟专注 / 5 分钟短休息 / 15 分钟长休息。
   - 5 个控制按钮：开始、暂停、继续、跳过、停止。
   - 实时倒计时显示（MM:SS 格式）。
   - 线性进度条（0-100%）。
   - 已完成番茄钟统计（持久化）。
   - 状态管理：空闲 → 专注中 → 短休息 → ...

3. **展开区域优化**：
   - 容器尺寸：700×250（原 600×200）。
   - 内容区域高度：190pt（标题 20pt + 模块切换器 24pt + Divider 1pt + 内容 190pt + 间距）。
   - 布局紧凑但不拥挤，所有内容可见无遮挡。

4. **交互优化**：
   - 鼠标监听逻辑：展开状态检查 700×250 区域，收起状态检查 200×55 触发区域。
   - 模块切换器：快捷方式 ⇄ 番茄钟，平滑切换。
   - 状态感知的按钮显示：根据番茄钟状态动态显示开始/暂停/继续按钮。

**技术要点**：
- 使用 `isPaused` 标记解决暂停/继续按钮切换问题。
- 番茄钟布局优化：压缩字体大小、间距、按钮尺寸，确保统计信息可见。
- 快捷方式布局：从 LazyVGrid 改为 LazyHGrid + ScrollView，避免高度不足。

**待实现功能**：
- 快捷方式添加/删除/管理界面。
- 网站图标自动获取（favicon）。
- 番茄钟系统通知。
- 音乐模块实现。

**关键文件**：
- `/Users/ryan/Learn/BarHold/NotchIsland/NotchIsland/App/NotchIslandApp.swift`（容器尺寸、鼠标监听）
- `/Users/ryan/Learn/BarHold/NotchIsland/NotchIsland/Modules/Shortcuts/ShortcutGridView.swift`（快捷方式 UI）
- `/Users/ryan/Learn/BarHold/NotchIsland/NotchIsland/Modules/Pomodoro/PomodoroView.swift`（番茄钟 UI）
- `/Users/ryan/Learn/BarHold/NotchIsland/NotchIsland/Modules/Pomodoro/PomodoroService.swift`（番茄钟逻辑）

## 2.7 阶段 7：v2 版本收尾与发布准备

- [ ] **阶段 7：v2 版本收尾与发布准备**
  - [ ] 应用信息完善：
    - [ ] 设计应用图标（macOS App Icon）。
    - [ ] 完善应用名称和描述。
    - [ ] 添加版本号管理。
  - [ ] 文档与说明：
    - [ ] 编写 README.md（功能介绍、使用说明）。
    - [ ] 添加截图和演示。
    - [ ] 编写安装与配置指南。
  - [ ] 代码清理与优化：
    - [ ] 移除调试日志。
    - [ ] 代码格式统一。
    - [ ] 优化注释和文档。
  - [ ] 测试与修复：
    - [ ] 完整功能测试。
    - [ ] 边界情况测试。
    - [ ] 性能测试（CPU、内存）。
  - [ ] 发布准备：
    - [ ] 配置代码签名。
    - [ ] 构建 Release 版本。
    - [ ] 准备发布说明。

### 2.8 阶段 8：v3 功能完善与体验优化

- [ ] **阶段 8：v3 功能完善与体验优化**
  - [ ] 待办事项集成：
    - [ ] 添加第4个模块标签"待办事项"。
    - [ ] 移除菜单栏的待办列表。
    - [ ] 设计紧凑列表 UI（190pt 高度）。
    - [ ] 支持添加/勾选/删除操作。
  - [ ] 快捷方式增强：
    - [ ] 支持分组/标签管理。
    - [ ] 快捷方式搜索功能。
    - [ ] 导入/导出快捷方式配置。
  - [ ] 番茄钟增强：
    - [ ] 自定义时长配置。
    - [ ] 番茄钟统计报表（每日/每周）。
    - [ ] 背景音乐/白噪音播放。
    - [ ] 与日历集成（记录到日历）。
  - [ ] 音乐模块增强：
    - [ ] 支持更多播放器（网易云、QQ音乐等）。
    - [ ] 专辑封面自动获取。
    - [ ] 歌词显示功能。
    - [ ] 音乐播放历史记录。
  - [ ] 设置界面完善：
    - [ ] 主题模式切换（深色/浅色）。
    - [ ] 开机自启动配置。
    - [ ] 模块显示/隐藏配置。
  - [ ] 性能优化：
    - [ ] 减少内存占用。
    - [ ] 优化动画性能。
    - [ ] 优化图标缓存机制。
  - [ ] 数据备份与同步：
    - [ ] iCloud 同步支持。
    - [ ] 本地备份/恢复功能。

### 2.9 阶段 9：v4 AI 模块与进阶功能

- [ ] **阶段 9：v4 AI 模块与进阶功能**
  - [ ] AI 小助手模块：
    - [ ] 设计对话 UI（小型弹出窗口）。
    - [ ] 接入 LLM API（如 OpenAI 或自建服务）。
    - [ ] 简单会话记录（可选）。
  - [ ] 智能提醒与自动化：
    - [ ] 根据日历事件、时间段等展示提醒信息。
    - [ ] 根据时间段或用户状态自动切换“专注模式”等。

## 3. 变更记录（可选）

> 若有重要计划调整，可以在此追加条目，例如：
> - 2026-01-11：初版开发计划文档创建，确立 v1/v2/v3 三阶段结构。
> - 2026-01-11：v1 阶段全部完成，包含时间/天气/Todo 模块及刘海动态交互架构预留。
> - 2026-01-12：v2 阶段 5 完成，创建快捷方式、番茄钟、音乐三个模块的数据模型和服务接口。
